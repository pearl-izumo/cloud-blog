---
layout: default
---

<article>
    <div id="notification-container"></div>
    <h1>{{ page.title }}</h1>

    {% assign IS_HIDDEN_POST = false %}

    {% assign HIDDEN_SLUGS = 'system-response-log' | split: ',' %}

    {% if HIDDEN_SLUGS contains page.slug %}
        {% assign IS_HIDDEN_POST = true %}
    {% endif %}

    {% if IS_HIDDEN_POST %}
        <p>æŠ•ç¨¿æ—¥: <span id="dynamic-post-date">ï¼ˆè¨˜éŒ²å‡¦ç†ä¸­...ï¼‰</span></p>
    {% else %}
        <p>æŠ•ç¨¿æ—¥: {{ page.date | date: "%Yå¹´%mæœˆ%dæ—¥" }}</p>
    {% endif %}

    <div class="post-content">
        {{ content }}
    </div>

    <hr style="margin-top: 40px;">
    
    <section id="comment-section">
        <h2>:: ã‚³ãƒ¡ãƒ³ãƒˆ / è¨˜éŒ² ::</h2>
        
        <div id="comment-form-area">
            <p>ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        
        <div id="comment-history-area">
            <p style="color: #666;">ï¼ˆç¾æ™‚ç‚¹ã§æ›¸ãè¾¼ã¾ã‚ŒãŸè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ï¼‰</p>
        </div>

    </section>

    <style>
        /* é€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        #notification-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; /* ä»–ã®è¦ç´ ã®ä¸Šã«è¡¨ç¤º */
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é€éã•ã›ã‚‹ */
        }
    
        /* å€‹åˆ¥é€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .toast-notification {
            background-color: #4CAF50; /* ç·‘è‰²ã®èƒŒæ™¯ */
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            
            /* ç”»é¢å¤–ã«éš ã™ãŸã‚ã®åˆæœŸä½ç½® */
            transform: translateY(-100%); 
            transition: transform 0.5s ease-in-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š */
            
            /* ä¸­å¤®å¯„ã›ã®ãŸã‚ã®è¨­å®š */
            margin: 0 auto;
            max-width: 400px;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
    
        /* è¡¨ç¤ºæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .toast-notification.show {
            transform: translateY(0); /* ç”»é¢å†…ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ */
        }
    </style>

</article>

<script>
    //const CURRENT_BLOG_PATH = "{{ page.blog_path }}";
    const BLOG_PATH = "{{ page.blog | default: 'xxxblog' }}"; // å®‰å…¨ã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å†è¨­å®š
    const CURRENT_PLAYER_ID = localStorage.getItem('arg_player_id') || 'unknown';
    const CURRENT_POST_SLUG = "{{ page.slug }}";
    const ENABLE_COMMENT_TRIGGER = "{% if page.enable_comment_trigger %}true{% else %}false{% endif %}" === 'true';

    const QUOTE_SLUG = "{{ page.quote_source_slug }}";
    const QUOTED_COMMENT_KEY = `comment_content_${BLOG_PATH}_${QUOTE_SLUG}`;

    // ã‚­ãƒ¼ã«ãƒ–ãƒ­ã‚°IDã¨ã‚¹ãƒ©ãƒƒã‚°ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€è¨˜äº‹ã”ã¨ã«çŠ¶æ…‹ã‚’åˆ†é›¢
    // ä¾‹: 'trigger_state_amaneblog_trigger-test'
    const FLAG_STATE_KEY = `trigger_state_${BLOG_PATH}_${CURRENT_POST_SLUG}`;
    // ä¾‹: 'comment_content_amaneblog_trigger-test'
    const COMMENT_CONTENT_KEY = `comment_content_${BLOG_PATH}_${CURRENT_POST_SLUG}`; 
    // ä¾‹: 'trigger_time_ms_amaneblog_trigger-test'
    const TRIGGER_TIME_MS_KEY = `trigger_time_ms_${BLOG_PATH}_${CURRENT_POST_SLUG}`;
    // æ—¥ä»˜ä¿å­˜ç”¨ã®ã‚­ãƒ¼ã‚’å®šç¾©
    const TRIGGER_DATE_KEY = `trigger_date_${BLOG_PATH}_${CURRENT_POST_SLUG}`;

    // ğŸ”‘ éš ã—è¨˜äº‹ã®ã‚¹ãƒ©ãƒƒã‚°åˆ¤å®šç”¨
    const HIDDEN_POST_SLUGS = ["system-response-log"]; // å˜ä¸€ã®ã‚¹ãƒ©ãƒƒã‚°ã«é™å®š
    const IS_HIDDEN_POST = HIDDEN_POST_SLUGS.includes(CURRENT_POST_SLUG);

    // ---------------------------------------------------
    // ğŸ”‘ ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆã¨è¡¨ç¤º
    // ---------------------------------------------------
    
    function renderCommentForm() {
        const formArea = document.getElementById('comment-form-area');
        
        // 1. ãƒˆãƒªã‚¬ãƒ¼ãŒç„¡åŠ¹ãªè¨˜äº‹ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ãªã„
        if (!ENABLE_COMMENT_TRIGGER) {
            formArea.innerHTML = '<p style="color: #888;">ï¼ˆã“ã®è¨˜éŒ²ã¯ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹ãƒ­ãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­ã§ã™ã€‚ï¼‰</p>';
            return;
        }

        const currentState = localStorage.getItem(FLAG_STATE_KEY);

        if (currentState === 'COMPLETED') {
            // 2. å®Œäº†å¾Œã®è¡¨ç¤º: æ–°ã—ã„è¨˜äº‹ãŒè¡¨ç¤ºã•ã‚ŒãŸã“ã¨ã‚’ç¤ºå”†
            formArea.innerHTML = '<p style="display: none;" id="timer-status"></p> ';
        } else if (currentState === 'PENDING') {
            // 3. å‡¦ç†ä¸­ã®è¡¨ç¤º: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã€ä½•ã‚‚è¡¨ç¤ºã—ãªã„
            formArea.innerHTML = `
                <p style="display: none;" id="timer-status"></p> 
            `;
            // è£ã§ã‚¿ã‚¤ãƒãƒ¼ç›£è¦–è‡ªä½“ã¯ç¶™ç¶šã•ã›ã‚‹ï¼ˆé‡è¦ï¼‰
            checkTriggerStatus(); 
        } else {
            // 4. åˆæœŸçŠ¶æ…‹: ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const formHtml = `
                <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px;">
                    <p><strong>[ æŠ•ç¨¿è€…: ${CURRENT_PLAYER_ID} ]</strong></p>
                    <form id="comment-form" onsubmit="handleCommentSubmit(event)">
                        <textarea id="comment-text" name="comment" rows="4" placeholder="è¨˜éŒ²ã‚’æ›¸ãè¾¼ã‚€..." style="width: 98%; padding: 5px; margin-bottom: 10px;"></textarea>
                        <button type="submit" style="padding: 8px 15px;">è¨˜éŒ²ã‚’é€ä¿¡</button>
                        <p id="comment-message" style="color: green; margin-top: 10px; display: none;"></p>
                    </form>
                </div>
            `;
            formArea.innerHTML = formHtml;
        }
    }

    // ---------------------------------------------------
    // ğŸ”‘ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç† (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²)
    // ---------------------------------------------------
    
    function handleCommentSubmit(event) {
        event.preventDefault(); 
        
        const commentText = document.getElementById('comment-text').value.trim();
        const messageElement = document.getElementById('comment-message');
        
        if (commentText.length === 0) {
            messageElement.textContent = "è¨˜éŒ²å†…å®¹ãŒç©ºã§ã™ã€‚";
            messageElement.style.color = 'red';
            messageElement.style.display = 'block';
            return;
        }

        // 1. å‡¦ç†å®Œäº†æ™‚åˆ»ã‚’è¨­å®š (ç¾åœ¨æ™‚åˆ» + 60ç§’)
        const ONE_MINUTE_MS = 60 * 1000;
        const triggerTime = Date.now() + ONE_MINUTE_MS; 
        
        // 2. Local Storageã«çŠ¶æ…‹ã‚’è¨˜éŒ²
        localStorage.setItem(FLAG_STATE_KEY, 'PENDING');
        localStorage.setItem(COMMENT_CONTENT_KEY, commentText);
        localStorage.setItem(TRIGGER_TIME_MS_KEY, triggerTime.toString());
        showNotification("ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚");

        if (!localStorage.getItem(TRIGGER_DATE_KEY)) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateToSave = `${year}-${month}-${day}`;
            
            localStorage.setItem(TRIGGER_DATE_KEY, dateToSave);
        }
        
        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ãƒªãƒ­ãƒ¼ãƒ‰
        messageElement.textContent = "";
        messageElement.style.color = 'green';
        messageElement.style.display = 'block';
        
        // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’æ›´æ–°ã—ã€PENDINGçŠ¶æ…‹ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹
        setTimeout(() => {
            window.location.href = window.location.href; 
        }, 1500);
    }
    
    // ---------------------------------------------------
    // ğŸ”‘ ã‚¿ã‚¤ãƒãƒ¼ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ (å®Œäº†ãƒã‚§ãƒƒã‚¯)
    // ---------------------------------------------------
    
    function checkTriggerStatus() {
        const statusElement = document.getElementById('timer-status');
        const currentState = localStorage.getItem(FLAG_STATE_KEY);
        const triggerTime = parseInt(localStorage.getItem(TRIGGER_TIME_MS_KEY), 10);

        if (currentState !== 'PENDING' || !triggerTime) {
            return;
        }

        console.log("--- Trigger System: PENDING ---");
        
        const updateTimer = () => {
            const now = Date.now();
            const remainingMs = triggerTime - now;

            if (remainingMs <= 0) {
                // å®Œäº†ï¼çŠ¶æ…‹ã‚’COMPLETEDã«æ›´æ–°ã—ã€ãƒªãƒ­ãƒ¼ãƒ‰
                localStorage.setItem(FLAG_STATE_KEY, 'COMPLETED');
                clearInterval(timerInterval);
                console.log("--- Trigger System: COMPLETED. Reloading... ---");
                window.location.reload();
                return;
            }

            // æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
            const remainingSeconds = Math.ceil(remainingMs / 1000);
            console.log(`Remaining time: ${remainingSeconds} seconds.`);
        };

        // 1ç§’ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°
        const timerInterval = setInterval(updateTimer, 10000);
        updateTimer(); // å³åº§ã«å®Ÿè¡Œ
    }


    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    document.addEventListener('DOMContentLoaded', renderCommentForm);

    // ---------------------------------------------------
    // ğŸ”‘ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¼•ç”¨å‡¦ç†
    // ---------------------------------------------------

    function quoteCommentContent() {
        // å¼•ç”¨ã—ãŸã„è¦ç´ ã‚’å–å¾—
        const quoteElement = document.getElementById('quoted-comment-content');
        
        // ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’å–å¾—
        const savedComment = localStorage.getItem(QUOTED_COMMENT_KEY);

        if (quoteElement && savedComment) {
            // è¦ç´ ãŒã‚ã‚Œã°ã€localStorageã®ã‚³ãƒ¡ãƒ³ãƒˆã§å†…å®¹ã‚’ç½®ãæ›ãˆã‚‹
            quoteElement.textContent = savedComment;
        }
    }

    // ---------------------------------------------------
    // ğŸ”‘ ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´è¡¨ç¤ºå‡¦ç†
    // ---------------------------------------------------

    function renderCommentHistory() {
        const historyContainer = document.getElementById('comment-history-area');
        const savedHistory = localStorage.getItem(COMMENT_CONTENT_KEY);

        // å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
        if (!historyContainer || !savedHistory) {
            return;
        }
        
        // å±¥æ­´HTMLã‚’ç”Ÿæˆ
        const historyHtml = `
            <div style="margin-top: 20px; padding: 10px; border-top: 1px solid #ddd;">
                <p style="font-weight: bold; margin-bottom: 5px;">--- è¨˜éŒ²å±¥æ­´ ---</p>
                <div style="border-left: 3px solid #ccc; padding-left: 10px; margin-bottom: 10px;">
                    <p style="margin: 0;"><strong>[${CURRENT_PLAYER_ID}] </strong>${new Date().toLocaleString()}</p>
                    <p style="white-space: pre-wrap; margin: 5px 0 0 0;">${savedHistory}</p>
                </div>
            </div>
        `;
        
        historyContainer.innerHTML = historyHtml;
    }

    // ---------------------------------------------------
    // ğŸ”‘ é€šçŸ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºå‡¦ç†
    // ---------------------------------------------------
    function showNotification(message) {
        const container = document.getElementById('notification-container');
        if (!container) return;

        // 1. é€šçŸ¥è¦ç´ ã®ç”Ÿæˆ
        const notification = document.createElement('div');
        notification.className = 'toast-notification';
        notification.textContent = message;

        // 2. ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
        container.appendChild(notification);
        
        // 3. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ã‚ãšã‹ã«é…å»¶ã•ã›ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã•ã›ã‚‹
        setTimeout(() => {
            notification.classList.add('show');
        }, 10); 

        // 4. è‡ªå‹•ã§æ¶ˆå»: 3ç§’å¾Œã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã—ã€DOMã‹ã‚‰å‰Šé™¤ã™ã‚‹
        setTimeout(() => {
            notification.classList.remove('show'); // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼ˆ0.5ç§’å¾Œï¼‰ã«è¦ç´ ã‚’DOMã‹ã‚‰å‰Šé™¤
            setTimeout(() => {
                notification.remove(); 
            }, 500); 
            
        }, 3000); // 3ç§’é–“è¡¨ç¤º
    }

    // ğŸ¯ ä¿®æ­£ç®‡æ‰€ 2: å¼•ç”¨å…ƒã®ãƒˆãƒªã‚¬ãƒ¼è¨˜äº‹ã®æ—¥ä»˜ã‚­ãƒ¼ã‚’å†æ§‹ç¯‰
    const QUOTE_DATE_KEY = `trigger_date_${BLOG_PATH}_${QUOTE_SLUG}`;

    function getDisplayDate() {
        // éš ã—è¨˜äº‹ã®å ´åˆã¯ã€ãƒˆãƒªã‚¬ãƒ¼è¨˜äº‹ã®æ—¥ä»˜ã‚’ãƒã‚§ãƒƒã‚¯
        if (IS_HIDDEN_POST && QUOTE_SLUG) {
            const savedDate = localStorage.getItem(QUOTE_DATE_KEY);
            // ä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ãã®æ—¥ä»˜ã‚’è¿”ã—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¿”ã™
            return savedDate || '---'; 
        }
        return ''; // ééš ã—è¨˜äº‹ã®å ´åˆã¯æ—¥ä»˜è¡¨ç¤ºå‡¦ç†ã‚’è¡Œã‚ãªã„
    }

    function renderDynamicDate() {
        // éš ã—è¨˜äº‹ã®å ´åˆã®ã¿å®Ÿè¡Œ
        if (!IS_HIDDEN_POST) {
            return; 
        }
        const dateElement = document.getElementById('dynamic-post-date');
        const displayDate = getDisplayDate();

        if (dateElement) {
            //æ°¸ç¶šåŒ–ã•ã‚ŒãŸæ—¥ä»˜ã‚’è¡¨ç¤º
            dateElement.textContent = `${displayDate}`;
        }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«è¿½åŠ 
    document.addEventListener('DOMContentLoaded', renderCommentForm);
    document.addEventListener('DOMContentLoaded', quoteCommentContent);
    document.addEventListener('DOMContentLoaded', renderCommentHistory);
    document.addEventListener('DOMContentLoaded', renderDynamicDate);// ğŸ‘ˆ ã“ã®è¡Œã‚’è¿½åŠ 

</script>